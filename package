#!/bin/bash

echo "ðŸ“¦ Packaging Encryptify..."

RELEASE_DATE=$(date +%Y-%m-%d)
RELEASE_DIR="release/${RELEASE_DATE}"

mkdir -p "${RELEASE_DIR}"

echo "ðŸ“… Release Date: ${RELEASE_DATE}"
echo "ðŸ“‚ Output: ${RELEASE_DIR}"

./compile

cat > build/MANIFEST.MF << EOF
Manifest-Version: 1.0
Main-Class: Main
Class-Path: lib/javafx.base.jar lib/javafx.controls.jar lib/javafx.graphics.jar
EOF

# Create JAR file
cd build
jar cfm ../encryptify.jar MANIFEST.MF *.class
cd ..

# Copy JAR to release folder
cp encryptify.jar "${RELEASE_DIR}/"

# Copy lib folder to release
cp -r lib "${RELEASE_DIR}/"

# Create launcher script in release folder
cat > "${RELEASE_DIR}/encryptify" << 'EOF'
#!/bin/bash
# Encryptify Launcher

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
java --module-path "$DIR/lib" --add-modules javafx.controls -jar "$DIR/encryptify.jar" "$@"
EOF

chmod +x "${RELEASE_DIR}/encryptify"

# Create Windows launcher in release folder
cat > "${RELEASE_DIR}/encryptify.bat" << 'EOF'
@echo off
setlocal

REM Get the directory where this script is located
set "DIR=%~dp0"

REM Check if Java is installed
java -version >nul 2>&1
if %ERRORLEVEL% neq 0 (
    echo ERROR: Java is not installed or not in PATH!
    echo Please install Java 11 or higher from https://adoptium.net/
    pause
    exit /b 1
)

REM Run the application
echo Starting CryptoDrop...
java --module-path "%DIR%lib" --add-modules javafx.controls -jar "%DIR%encryptify.jar" %*

REM Check if application exited with error
if %ERRORLEVEL% neq 0 (
    echo.
    echo Application exited with error code: %ERRORLEVEL%
    pause
)

endlocal
EOF

# Create README in release folder
cat > "${RELEASE_DIR}/README.txt" << EOF
CryptoDrop - File Encryption Tool
Release: ${RELEASE_DATE}

INSTALLATION:
  No installation needed! Just run the launcher.

RUNNING THE APPLICATION:
  Linux/Mac: ./encryptify
  Windows:   encryptify.bat

REQUIREMENTS:
  - Java 11 or higher
  - JavaFX libraries (included in lib/ folder)

FILES:
  - encryptify.jar  : The application
  - encryptify      : Linux/Mac launcher
  - encryptify.bat  : Windows launcher
  - lib/            : JavaFX dependencies

USAGE:
  1. Run the application
  2. Drag and drop .txt files into the window
  3. Set an encryption key
  4. Choose cipher (Caesar, XOR, or AES)
  5. Encrypt or decrypt your files

For more information, visit the project repository.
EOF

echo ""
echo "âœ… Package created successfully!"
echo ""
